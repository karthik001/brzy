#!/bin/bash

CLASSPATH=""
for lib in "$BRZY_HOME/lib"/*.jar
do
   CLASSPATH=$CLASSPATH:$lib
done

# create-app can be called from anywhere
if [ "$1" = "create-app" ]; then
   SCRIPT="$BRZY_HOME/scripts/create-app.scala"
   exec scala-2.8 -savecompiled -cp $CLASSPATH $SCRIPT `pwd` $BRZY_HOME
   exit 0
fi

if [ "$1" = "-version" ]; then
   java -version
   scala-2.8 -version
   echo "brzy version 0.2"
   exit 0
fi

# check that it's a project directory
if [ ! -f "brzy-webapp.b.yml" ]; then
   echo "Not a brzy project directory"
   exit 1
fi

# bootstrap
if [ "$1" = "bootstrap" ]; then
   #TODO check last modified dates
   SCRIPT="$BRZY_HOME/scripts/boot1.scala"
   scala-2.8 -savecompiled -cp $CLASSPATH $SCRIPT `pwd` $BRZY_HOME
   FILES="project/brzy-plugins/*/*[0-9].jar"
   for f in $FILES
   do
       CLASSPATH="$CLASSPATH:`pwd`/$f"
   done
   SCRIPT="$BRZY_HOME/scripts/boot2.scala"
   scala-2.8 -savecompiled -cp $CLASSPATH $SCRIPT `pwd` $BRZY_HOME
   java -Xmx512m -jar $BRZY_HOME/sbt-launch.jar update
   exit 0
fi

# run any other script, looking in brzy, project and plugin directories
for i in "$BRZY_HOME/scripts"/*.scala
do
   if [ "`basename ${i%%.*}`" = "$1" ]; then
       SCRIPT=$i
   fi
done

if [ ! -e "$SCRIPT" ]; then
   for i in "scripts"/*.scala
   do
       if [ "`basename ${i%%.*}`" = "$1" ]; then
           SCRIPT=$i
           for lib in "lib"/*.jar
           do
               CLASSPATH=$CLASSPATH:$lib
           done
       fi
   done
fi

if [ ! -e "$SCRIPT" ]; then
   for plugin in "`pwd`/project/brzy-plugins"/*
   do
       for file in "$plugin/scripts"/*.scala
       do
           if [ "`basename ${file%.*}`" = "$1" ];  then
               SCRIPT=$file
               CLASSPATH=""
               for lib in "$plugin/lib"/*.jar
               do
                   CLASSPATH=$CLASSPATH:$lib
               done
           fi
       done
   done
fi

if [ -e "$SCRIPT" ]; then
    echo "script    : $SCRIPT"
    echo "classpath : $CLASSPATH"
    echo "pwd       : `pwd`"
    exec scala-2.8 -savecompiled -cp $CLASSPATH $SCRIPT `pwd` $BRZY_HOME $@
else
    echo "sbt : $@"
    java -Xmx512m -jar $BRZY_HOME/sbt-launch.jar $@
fi

