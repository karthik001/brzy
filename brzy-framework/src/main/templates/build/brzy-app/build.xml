<?xml version="1.0"?>
<project xmlns:ivy="antlib:org.apache.ivy.ant"
         xmlns:scala="antlib:scala.tools.ant"
         name="brzy-app" default="build" basedir="../">
  <property environment="env"/>
  <import file="./common.xml"/>
  <property name="script.dir" value=".brzy"/>
  <property file="${basedir}/${script.dir}/build.properties"/>
  <property name="brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
" location="${basedir}/brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
" />




	<target name="check.env" unless="brzy.env">
		<property name="brzy.env" value="development" />
	</target>
  <target name="install-scala">
    <taskdef resource="scala/tools/ant/antlib.xml" uri="antlib:scala.tools.ant">
      <classpath>
        <pathelement location="${scala-compiler.jar.file}"/>
        <pathelement location="${scala-library.jar.file}"/>
      </classpath>
    </taskdef>
  </target>
  <target name="install-ivy" description="--&gt; install ivy">
    <taskdef resource="org/apache/ivy/ant/antlib.xml" uri="antlib:org.apache.ivy.ant">
      <classpath>
        <pathelement location="${ivy.jar.file}"/>
      </classpath>
    </taskdef>
  </target>
  <target name="resolve" depends="install-scala,install-ivy" description="--> retrieve dependencies with ivy">
    <ivy:settings file=".brzy/ivysettings.xml"/>
    <ivy:resolve file=".brzy/ivy.xml"/>
    <ivy:retrieve conf="compile" pattern="${lib.dir}/[artifact]-[revision].[ext]"/>
    <ivy:cachepath pathid="default.classpath" conf="compile"/>
    <ivy:cachepath pathid="test.classpath" conf="test"/>
    <ivy:cachepath pathid="builder.classpath" conf="builder"/>
  </target>
  <target name="report" depends="resolve" description="--> generates a report of dependencies">
    <ivy:report todir="target/dependency-report"/>
  </target>
  <path id="brzy.module.bootclasspath">
    <!-- Paths to be included in compilation bootclasspath -->
  </path>
  <path id="brzy.runtime.module.classpath">
    <pathelement location="${output.dir}"/>
    <pathelement location="${testoutput.dir}"/>
  </path>
  <patternset id="excluded.from">
    <patternset refid="ignored.files"/>
  </patternset>
  <patternset id="excluded.from.compilation.brzy">
    <patternset refid="excluded.from"/>
  </patternset>
  <path id="brzy.module.sourcepath">
    <dirset dir="${basedir}">
      <include name="src/main/scala"/>
      <include name="src/main/java"/>
    </dirset>
  </path>
  <path id="brzy.module.test.sourcepath">
    <dirset dir="${basedir}">
      <include name="src/test/java"/>
      <include name="src/test/scala"/>
    </dirset>
  </path>
  <target name="compile" depends="resolve" description="Compile module brzy; production classes">
    <mkdir dir="${output.dir}"/>
	<pathconvert pathsep=":" property="classpath.files" refid="default.classpath"/>
	<!--<echo>${classpath.files}</echo>-->
    <scala:scalac destdir="${output.dir}">
      <src refid="brzy.module.sourcepath"/>
      <!--<classpath refid="brzy.module.classpath"/>-->
      <classpath refid="default.classpath"/>
      <patternset refid="excluded.from.compilation.brzy"/>
    </scala:scalac>
    <!-- <javac destdir="${output.dir}" debug="${compiler.debug}"
               nowarn="${compiler.generate.no.warnings}" memorymaximumsize="${compiler.max.memory}"
               fork="true">
          <compilerarg line="${compiler.args.brzy}"/>
          <bootclasspath refid="brzy.module.bootclasspath"/>
          <classpath>
            <pathelement location="${output.dir}"/>
            <path refid="default.classpath"/>
          </classpath>
          <src refid="brzy.module.sourcepath"/>
          <patternset refid="excluded.from.compilation.brzy"/>
        </javac> -->
  </target>
  <target name="compile.tests" depends="compile" description="compile module brzy; test classes"
          unless="skip.tests">
    <mkdir dir="${testoutput.dir}"/>
    <scala:scalac destdir="${testoutput.dir}">
      <src refid="brzy.module.test.sourcepath"/>
      <classpath>
        <path refid="test.classpath"/>
        <pathelement location="${output.dir}"/>
      </classpath>
      <patternset refid="excluded.from.compilation.brzy"/>
    </scala:scalac>
    <!-- <javac destdir="${testoutput.dir}" debug="${compiler.debug}"
               nowarn="${compiler.generate.no.warnings}" memorymaximumsize="${compiler.max.memory}"
               fork="true">
          <compilerarg line="${compiler.args.brzy}"/>
          <bootclasspath refid="brzy.module.bootclasspath"/>
          <classpath>
            <pathelement location="${testoutput.dir}"/>
            <path refid="test.classpath"/>
            <pathelement location="${output.dir}"/>
          </classpath>
          <src refid="brzy.module.test.sourcepath"/>
          <patternset refid="excluded.from.compilation.brzy"/>
        </javac> -->
  </target>
  <target name="test" depends="compile.tests">
    <junit printsummary="yes" haltonfailure="yes">
      <classpath>
        <path refid="test.classpath"/>
      </classpath>
      <formatter type="plain"/>
      <batchtest fork="yes" todir="${basedir}/target/test-reports">
        <fileset dir="${basedir}/src/test/scala">
          <include name="**/*Test.java"/>
        </fileset>
      </batchtest>
    </junit>
  </target>
	<target name="assemble.web-inf" depends="compile,check.env">
    <echo>Assemble WEB-INF</echo>
		<mkdir dir="${webapp.temp.dir}" />
		<mkdir dir="${webapp.temp.dir}/WEB-INF" />
		<mkdir dir="${webapp.temp.dir}/WEB-INF/lib" />
		<mkdir dir="${webapp.temp.dir}/WEB-INF/classes" />
  </target>
	<target name="copy.webapp" depends="assemble.web-inf">
    <echo>Copy webapp content</echo>
		 <copy todir="${webapp.temp.dir}">
        <fileset dir="${basedir}/webapp">
					<patternset refid="ignored.files" />
          <!-- <include name="**/*"/> -->
        </fileset>
      </copy>
  </target>
  <target name="assemble.lib" depends="copy.webapp">
    <echo>Assemble Lib</echo>
		<ivy:retrieve pattern="${webapp.temp.dir}/WEB-INF/lib/[artifact]-[revision].[ext]" conf="compile"/>
  </target>
	<target name="make.persistencexml" depends="assemble.lib">
    <echo>Make persistence.xml</echo>
	 <!-- <pathconvert pathsep=":" property="classpath.files" refid="builder.classpath"/>
		<echo>${classpath.files}</echo>  -->
		<property name="metainf.loc" location="${webapp.temp.dir}/WEB-INF/classes/META-INF/"/>
		<mkdir dir="${metainf.loc}" />
		<property name="persistencexml.loc" location="${metainf.loc}/persistence.xml" />
		<java classname="org.brzy.build.Main">
      <arg value="${brzy.env}"/>
      <arg value="persistence"/>
      <arg value="${brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
}"/>
			<arg value="${persistencexml.loc}"/>
      <classpath refid="builder.classpath"/>
    </java>
  </target>
  <target name="make.webxml" depends="assemble.lib"><!-- make.persistencexml -->
    <echo>Make web.xml</echo>
		<property name="webxml.loc" location="${webapp.temp.dir}/WEB-INF/web.xml" />
		<java classname="org.brzy.build.Main">
      <arg value="${brzy.env}"/>
      <arg value="web"/>
      <arg value="${brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
}"/>
			<arg value="${webxml.loc}"/>
      <classpath refid="builder.classpath"/>
    </java>
  </target>
  <target name="make.logbackxml" depends="make.webxml">
    <echo>Make logback.xml</echo>
    <property name="logback.loc" location="${webapp.temp.dir}/WEB-INF/classes/logback.xml" />
	<java classname="org.brzy.build.Main">
      <arg value="${brzy.env}"/>
      <arg value="logback"/>
      <arg value="${brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
}"/>
  	  <arg value="${logback.loc}"/>
      <classpath refid="builder.classpath"/>
    </java>
  </target>
  <target name="copy.config" depends="make.logbackxml">
    <echo>Make brzy config</echo>
		<copy file="${brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
}" tofile="${webapp.temp.dir}/WEB-INF/classes/brzy-webapp.b.yml
#Wed May 26 21:30:14 EDT 2010
project.organization=org.brzy.demo
project.name=demo
sbt.version=0.7.4
project.version=1.0
build.scala.versions=2.8.0.RC2
project.initialize=false
" overwrite="true" />
		<copy todir="${webapp.temp.dir}/WEB-INF/classes">
	    <fileset dir="${output.dir}" includes="**/*.class"/>
	  </copy>
  </target>
  <target name="build" depends="test,copy.config"/>
	<target name="war" depends="build">
		<war destfile="target/brzy-app.war" webxml="${webapp.temp.dir}/WEB-INF/web.xml" basedir="${webapp.temp.dir}">
      <!-- <fileset dir="${pages.dir}"/>
      <lib dir="${lib.dir}" />
      <classes dir="${temp.dir.classes}" /> -->
    </war>
	</target>
  <target name="clean" description="cleanup module">
    <delete dir="${basedir}/target"/>
  </target>
  <target name="clean-ivy" description="--&gt; clean the ivy installation">
    <delete dir="${ivy.jar.dir}"/>
  </target>
  <target name="clean-cache" depends="install-ivy" description="--&gt; clean the ivy cache">
    <ivy:cleancache/>
  </target>
</project>
